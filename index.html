<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartFinance - ØªØ­Ù„ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠÙ‡</title>

  <!-- Firebase (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --muted: #6b7280;
    }
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      direction: rtl;
      color: var(--text-main);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #0f172a;
      color: #e5e7eb;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title {
      font-size: 18px;
      font-weight: 700;
    }

    header .user-info {
      font-size: 12px;
      text-align: left;
    }

    header button {
      background: #ef4444;
      border: none;
      color: white;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    main {
      padding: 10px;
      max-width: 900px;
      margin: 0 auto 40px auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.06);
    }

    h2,h3 { margin: 0 0 8px 0; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover { background: var(--primary-dark); }

    .btn-small {
      width: auto;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      margin: 0 2px;
    }

    .muted { font-size: 12px; color: var(--muted); }

    .row { display: flex; gap: 10px; }
    .row > div { flex: 1; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    th { background: #e5e7eb; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 11px;
    }

    /* GPS Overlay */
    #gpsOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.96);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 100;
    }
    #gpsBox {
      max-width: 420px;
      width: 100%;
      background: #020617;
      border-radius: 18px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    }
    #gpsBox h2 { margin-bottom: 8px; }
    #gpsBox p { font-size: 13px; color: #9ca3af; margin: 4px 0; }
    #gpsBox button { border-radius: 999px; margin-top: 8px; }
    #gpsStatus { font-size: 12px; margin-top: 6px; min-height: 16px; }

    /* Login screen */
    #loginScreen {
      min-height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    #loginBox {
      width: 100%;
      max-width: 360px;
      background: white;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      text-align: center;
    }

    .lang-buttons { margin: 8px 0 4px; }
    .lang-buttons button { width: auto; }

    /* AI box */
    .ai-box {
      background: #eff6ff;
      border-radius: 14px;
      padding: 10px;
      margin-top: 10px;
      text-align: right;
    }
    .ai-title {
      font-size: 13px;
      color: #1d4ed8;
      font-weight: 600;
      margin-bottom: 4px;
    }
    #aiText { font-size: 13px; white-space: pre-line; }

    @media (max-width: 600px){
      main { padding: 8px; }
      header .title { font-size: 16px; }
    }
  </style>
</head>
<body>

  <!-- GPS Ø£ÙˆÙ„Ø§Ù‹ -->
  <div id="gpsOverlay">
    <div id="gpsBox">
      <h2>ğŸ“ ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
      <p>Ù„Ø£Ù…Ø§Ù† ÙˆØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ù‚ØŒ ÙŠØ­ØªØ§Ø¬ SmartFinance Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.</p>
      <p class="muted">Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©ØŒ ÙˆÙ„Ø§ ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.</p>
      <button onclick="requestLocation()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†</button>
      <div id="gpsStatus"></div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginScreen">
    <div id="loginBox">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <p class="muted">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„ØªÙŠ Ø£Ø¹Ø·Ø§Ùƒ ÙŠØ§Ù‡Ø§ Ø§Ù„Ø£Ø¯Ù…Ù†.</p>

      <div class="lang-buttons">
        <button class="btn-small" onclick="setLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
        <button class="btn-small" onclick="setLang('ku')">Ú©ÙˆØ±Ø¯ÛŒ</button>
        <button class="btn-small" onclick="setLang('en')">English</button>
      </div>

      <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      <p class="muted" id="loginMsg"></p>
    </div>
  </div>

  <!-- Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <header id="appHeader" style="display:none;">
    <div class="title">SmartFinance - ØªØ­Ù„ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠÙ‡</div>
    <div class="user-info">
      <div id="headerUser">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: â€”</div>
      <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main id="appMain" style="display:none;">
    <div class="card">
      <h3 id="salaryLabel">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
      <input type="number" id="salaryInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø§ØªØ¨Ùƒ">
      <button id="saveSalaryBtn" onclick="saveSalary()">Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨</button>

      <div class="row" style="margin-top:10px;">
        <div>
          <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
          <div><span class="badge" id="totalSpend">0</span></div>
        </div>
        <div>
          <div class="muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨</div>
          <div><span class="badge" id="remainSalary">0</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 id="addExpenseLabel">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
      <input type="date" id="expDate">
      <select id="expType">
        <option value="Food">Ø£ÙƒÙ„</option>
        <option value="Rent">Ø¥ÙŠØ¬Ø§Ø±</option>
        <option value="Internet">Ø¥Ù†ØªØ±Ù†Øª</option>
        <option value="Transport">Ù†Ù‚Ù„</option>
        <option value="Shopping">ØªØ³ÙˆÙ‚</option>
        <option value="Other">ØºÙŠØ± Ø°Ù„Ùƒ</option>
      </select>
      <input placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" id="note">
      <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" id="amount">
      <button id="addBtn" onclick="addExpense()">Ø¥Ø¶Ø§ÙØ©</button>

      <div class="ai-box">
        <div class="ai-title">ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</div>
        <div id="aiText">
          Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙØŒ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØµØ±ÙÙƒ Ø¨Ø«Ù„Ø§Ø« Ù„ØºØ§Øª.
        </div>
      </div>
    </div>

    <div class="card">
      <h3 id="listLabel">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
      <div class="muted" id="gpsInfo">Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…ÙØ¹Ù„ Ø¨Ø¹Ø¯.</div>
      <table>
        <thead>
          <tr>
            <th id="tDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th id="tType">Ø§Ù„Ù†ÙˆØ¹</th>
            <th id="tNote">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            <th id="tAmount">Ø§Ù„Ù…Ø¨Ù„Øº</th>
          </tr>
        </thead>
        <tbody id="expTable"></tbody>
      </table>
    </div>
  </main>

<script>
  // ========= 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase =========
  // TODO: Ù‡Ù†Ø§ ØªÙ„ØµÙ‚ firebaseConfig Ø§Ù„Ù„ÙŠ Ø£Ø®Ø°ØªÙ‡ Ù…Ù† Firebase console
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®...
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let currentLang = "ar";
  let expenses = [];
  let salary = 0;
  let gpsLat = null, gpsLng = null;

  const langText = {
    ar: {
      loginMsg: "Ø¥Ø°Ø§ Ù…Ø§ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù†.",
      salaryLabel: "Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ",
      saveSalaryBtn: "Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨",
      addExpenseLabel: "Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ",
      listLabel: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ",
      tDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
      tType: "Ø§Ù„Ù†ÙˆØ¹",
      tNote: "Ù…Ù„Ø§Ø­Ø¸Ø©",
      tAmount: "Ø§Ù„Ù…Ø¨Ù„Øº",
      aiIntro: "Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙØŒ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØµØ±ÙÙƒ.",
    },
    ku: {
      loginMsg: "Ø¦Û•Ú¯Û•Ø± Ù‡Ù‡â€Œ Ø­Ø³Ø§Ø¨Û•Øª Ù†ÛŒÛ•ØŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¨Û• Ø¦Û•Ø¯Ù…ÛŒÙ† Ø¨Ú©Û•.",
      salaryLabel: "Ù…ÙˆÙˆÚ†Û•ÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•",
      saveSalaryBtn: "Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†ÛŒ Ù…ÙˆÙˆÚ†Û•",
      addExpenseLabel: "Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø®Û•Ø±Ø¬ÛŒ",
      listLabel: "Ù„ÛŒØ³ØªÛŒ Ø®Û•Ø±Ø¬ÛŒÛ•Ú©Ø§Ù†",
      tDate: "Ø±ÛÚ©Û•ÙˆØª",
      tType: "Ø¬Û†Ø±",
      tNote: "ØªÛØ¨ÛŒÙ†ÛŒ",
      tAmount: "Ø¨Ú•",
      aiIntro: "Ù…ÙˆÙˆÚ†Û• Ùˆ Ø®Û•Ø±Ø¬ÛŒ Ø²ÛŒØ§Ø¯ Ø¨Ú©Û•ØŒ Ù…Ù† Ú•Ø§Ù¾Û†Ø±Øª Ùˆ Ú•Ø§ÙˆÛŒØ³ØªÛŒ Ø®Û•Ø±Ø¬ÛŒ Ø¨Û†Øª Ø¯Û•Ù….",
    },
    en: {
      loginMsg: "If you don't have an account, contact the admin.",
      salaryLabel: "Monthly Salary",
      saveSalaryBtn: "Save Salary",
      addExpenseLabel: "Add Expense",
      listLabel: "Expenses List",
      tDate: "Date",
      tType: "Type",
      tNote: "Note",
      tAmount: "Amount",
      aiIntro: "Enter your salary and expenses, I'll give you insights and tips.",
    }
  };

  function setLang(l) {
    currentLang = l;
    document.getElementById("loginMsg").innerText = langText[l].loginMsg;
    document.getElementById("salaryLabel").innerText = langText[l].salaryLabel;
    document.getElementById("saveSalaryBtn").innerText = langText[l].saveSalaryBtn;
    document.getElementById("addExpenseLabel").innerText = langText[l].addExpenseLabel;
    document.getElementById("listLabel").innerText = langText[l].listLabel;
    document.getElementById("tDate").innerText = langText[l].tDate;
    document.getElementById("tType").innerText = langText[l].tType;
    document.getElementById("tNote").innerText = langText[l].tNote;
    document.getElementById("tAmount").innerText = langText[l].tAmount;
    if (!salary && expenses.length === 0) {
      document.getElementById("aiText").innerText = langText[l].aiIntro;
    } else {
      aiAnalyze();
    }
  }

  // ========= 2) GPS Overlay =========
  function requestLocation() {
    const status = document.getElementById("gpsStatus");
    status.style.color = "#e5e7eb";
    status.innerText = "â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­...";

    if (!navigator.geolocation) {
      status.innerText = "Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        gpsLat = pos.coords.latitude.toFixed(6);
        gpsLng = pos.coords.longitude.toFixed(6);
        localStorage.setItem("sf_lat", gpsLat);
        localStorage.setItem("sf_lng", gpsLng);
        document.getElementById("gpsOverlay").style.display = "none";
        document.getElementById("loginScreen").style.display = "flex";
      },
      (err) => {
        status.style.color = "#fca5a5";
        status.innerText = "Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.";
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  function updateGpsInfo() {
    const el = document.getElementById("gpsInfo");
    if (gpsLat && gpsLng) {
      el.innerText = `Ø§Ù„Ù…ÙˆÙ‚Ø¹: (${gpsLat}, ${gpsLng})`;
    } else {
      el.innerText = "Ø§Ù„Ù…ÙˆÙ‚Ø¹: ØºÙŠØ± Ù…ÙØ¹Ù„ Ø¨Ø¹Ø¯.";
    }
  }

  // ========= 3) Auth & Firestore =========
  async function login() {
    const email = document.getElementById("loginEmail").value.trim();
    const pass  = document.getElementById("loginPassword").value.trim();
    if (!email || !pass) {
      alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      // onAuthStateChanged Ø±Ø§Ø­ ÙŠØ´ØªØºÙ„
    } catch (e) {
      console.error(e);
      alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØµØ§Ø± Ø®Ø·Ø£.");
    }
  }

  function logout() {
    auth.signOut();
  }

  function loadUserData(uid) {
    // Ø§Ù„Ø±Ø§ØªØ¨
    db.collection("users").doc(uid).collection("meta").doc("profile")
      .get()
      .then(doc => {
        if (doc.exists) {
          salary = doc.data().salary || 0;
          document.getElementById("salaryInput").value = salary || "";
        }
        updateTotals();
        aiAnalyze();
      });

    // Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Realtime)
    db.collection("users").doc(uid).collection("expenses")
      .orderBy("date", "asc")
      .onSnapshot(snap => {
        expenses = [];
        snap.forEach(doc => {
          expenses.push({ id: doc.id, ...doc.data() });
        });
        renderExpenses();
        updateTotals();
        aiAnalyze();
      });
  }

  async function saveSalary() {
    if (!currentUser) return;
    if (!gpsLat || !gpsLng) {
      alert("ÙØ¹Ù‘Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨.");
      return;
    }
    const val = Number(document.getElementById("salaryInput").value);
    if (!val) {
      alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
      return;
    }
    salary = val;
    await db.collection("users").doc(currentUser.uid).collection("meta").doc("profile")
      .set({ salary }, { merge: true });
    updateTotals();
    aiAnalyze();
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨.");
  }

  async function addExpense() {
    if (!currentUser) return;
    if (!gpsLat || !gpsLng) {
      alert("ÙØ¹Ù‘Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ.");
      return;
    }
    const date = document.getElementById("expDate").value;
    const type = document.getElementById("expType").value;
    const note = document.getElementById("note").value || "-";
    const amount = Number(document.getElementById("amount").value);

    if (!date || !amount) {
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº.");
      return;
    }

    const docData = {
      date,
      type,
      note,
      amount,
      lat: gpsLat,
      lng: gpsLng,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("users").doc(currentUser.uid).collection("expenses").add(docData);

    document.getElementById("note").value = "";
    document.getElementById("amount").value = "";
  }

  function renderExpenses() {
    const tbody = document.getElementById("expTable");
    tbody.innerHTML = "";
    expenses.forEach(e => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.date || ""}</td>
        <td>${e.type || ""}</td>
        <td>${e.note || ""}</td>
        <td>${e.amount || 0}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateTotals() {
    const total = expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0);
    const remain = (salary || 0) - total;
    document.getElementById("totalSpend").innerText = total;
    document.getElementById("remainSalary").innerText = remain;
  }

  // ========= 4) AI Ø¨Ø³ÙŠØ· Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© =========
  function aiAnalyze() {
    const el = document.getElementById("aiText");
    if (!salary) {
      if (currentLang === "ar") el.innerText = "Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ø­ØªÙ‰ Ø£Ø³ØªØ·ÙŠØ¹ ØªØ­Ù„ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„ØµØ±Ù.";
      else if (currentLang === "ku") el.innerText = "Ø³Û•Ø±Û•ØªØ§ Ù…ÙˆÙˆÚ†Û•Ú©Û• Ø¯Ø§Ø®Ù„ Ø¨Ú©Û• Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø¨ØªÙˆØ§Ù†Ù… Ø®Û•Ø±Ø¬ÛŒÛ•Ú©Ø§Ù†Øª Ø¨ÚµØ§Ùˆ Ø¨Ú©Û•Ù…Û•ÙˆÛ•.";
      else el.innerText = "Enter your salary first so I can analyze your spending.";
      return;
    }
    if (expenses.length === 0) {
      if (currentLang === "ar") el.innerText = "Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…ØµØ±ÙˆÙ ÙˆØ³Ø£Ø®Ø¨Ø±Ùƒ Ø¥Ø°Ø§ ØµØ±ÙÙƒ Ø·Ø¨ÙŠØ¹ÙŠ Ø£Ùˆ Ø¹Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø±Ø§ØªØ¨Ùƒ.";
      else if (currentLang === "ku") el.innerText = "ÛŒÛ•Ú©Û•Ù… Ø®Û•Ø±Ø¬ÛŒ Ø²ÛŒØ§Ø¯ Ø¨Ú©Û•ØŒ Ø¯ÙˆØ§ØªØ± Ø¯Û•ÚµÛÙ… Ø¦Ø§ÛŒØ§ Ø¨Û•Ø±Ø§ÙˆØ±Ø¯ Ø¨Û• Ù…ÙˆÙˆÚ†Û•Ú©Û•Øª Ø²Û†Ø±Û• ÛŒØ§Ù† Ù†Ø§.";
      else el.innerText = "Add your first expense and I'll tell you if your spending is normal or high.";
      return;
    }

    const total = expenses.reduce((s, e) => s + (Number(e.amount) || 0), 0);
    const percent = (total / salary) * 100;
    let msg = "";

    if (currentLang === "ar") {
      msg += `ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµØ±Ù: ${total} Ù…Ù† Ø±Ø§ØªØ¨ ${salary} (${percent.toFixed(1)}%).\n`;
      if (percent < 30) msg += "âœ… ØµØ±ÙÙƒ Ù…Ù…ØªØ§Ø² ÙˆÙ…Ø³ÙŠØ·Ø± Ø¹Ù„ÙŠÙ‡.\n";
      else if (percent < 70) msg += "âš ï¸ ØµØ±ÙÙƒ Ù…ØªÙˆØ³Ø·ØŒ Ø§Ù†ØªØ¨Ù‡ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ù‡Ø±.\n";
      else msg += "ğŸš¨ ØµØ±ÙÙƒ Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø­ØªÙ…Ø§Ù„ ØªØ®Ù„Øµ ÙÙ„ÙˆØ³Ùƒ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±.\n";

      const internet = expenses.filter(e => e.type === "Internet" || e.type === "Ø¥Ù†ØªØ±Ù†Øª")
        .reduce((s, e) => s + (Number(e.amount) || 0), 0);
      if (internet > salary * 0.1) {
        msg += "ğŸ’¡ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ø¹Ù„Ù‰ Ù…Ù† 10% Ù…Ù† Ø±Ø§ØªØ¨ÙƒØŒ ÙÙƒØ± Ø¨ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø·Ø©.\n";
      }

    } else if (currentLang === "ku") {
      msg += `ğŸ“Š Ú©Û†ÛŒ Ø®Û•Ø±Ø¬ÛŒ: ${total} Ù„Û• Ù…ÙˆÙˆÚ†Û•ÛŒ ${salary} (${percent.toFixed(1)}%).\n`;
      if (percent < 30) msg += "âœ… Ø®Û•Ø±Ø¬ÛŒÚ©Û•Øª Ø²Û†Ø± Ø¨Ø§Ø´Û• Ùˆ Ø¨Û•Ú•ÛÙˆØ¨Û•Ø±ÛŒ Ø¨Ø§Ø´ Ø¯Û•Ú©Û•ÛŒØª.\n";
      else if (percent < 70) msg += "âš ï¸ Ø®Û•Ø±Ø¬ÛŒÛ•Ú©Ø§Ù†Øª Ù†Ø§ÙˆÛ•Ù†Ø¯ÛŒÙ†ØŒ Ù‡Û•ÙˆÚµ Ø¨Ø¯Û• Ù…Ø§ÙˆÛ•ÛŒ Ù…Ø§Ù†Ú¯ Ø¨Ø¨ÛŒÙ†ÛŒØª.\n";
      else msg += "ğŸš¨ Ø®Û•Ø±Ø¬ÛŒÚ©Û•Øª Ø²Û†Ø± Ú†ÛÚ˜Ø§ÙˆÛ•ØŒ Ù„Û•ÙˆØ§Ù†Û•ÛŒÛ• Ù…ÙˆÙˆÚ†Û•Ú©Û•Øª Ù¾ÛØ´ Ù…Ø§Ù†Ú¯ Ú©Û†ØªØ§ÛŒÛŒ ÛŒÛ• Ø¨ÛØª.\n";

    } else {
      msg += `ğŸ“Š Total spending: ${total} out of ${salary} (${percent.toFixed(1)}%).\n`;
      if (percent < 30) msg += "âœ… Your spending is very healthy so far.\n";
      else if (percent < 70) msg += "âš ï¸ Your spending is moderate, keep an eye on the rest of the month.\n";
      else msg += "ğŸš¨ Your spending is very high, you may run out of money before month-end.\n";
    }

    el.innerText = msg;
  }

  // ========= 5) onAuthStateChanged =========
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("appHeader").style.display = "flex";
      document.getElementById("appMain").style.display = "block";
      document.getElementById("headerUser").innerText = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + (user.email || "");
      loadUserData(user.uid);
    } else {
      document.getElementById("appHeader").style.display = "none";
      document.getElementById("appMain").style.display = "none";
      // Ù„Ø§ Ù†Ø±Ø¬Ø¹ GPS Ù„Ø£Ù†Ù‘Ù‡ ØµØ§Ø± already
      document.getElementById("loginScreen").style.display = "flex";
    }
  });

  // ========= 6) On load =========
  window.addEventListener("load", () => {
    // Ù„Ùˆ Ù…Ø®Ø²ÙˆÙ† GPS Ù‚Ø¯ÙŠÙ…
    gpsLat = localStorage.getItem("sf_lat");
    gpsLng = localStorage.getItem("sf_lng");
    updateGpsInfo();
    setLang("ar");
  });
</script>

</body>
</html>
