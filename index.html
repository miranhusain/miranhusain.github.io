<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ­Ù„ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠÙ‡</title>

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #059669;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      direction: rtl;
      color: var(--text-main);
    }

    /* Ù‡ÙŠØ¯Ø± Ø«Ø§Ø¨Øª */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #0f172a;
      color: #e5e7eb;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title {
      font-size: 18px;
      font-weight: bold;
    }

    header .user-info {
      font-size: 13px;
      text-align: left;
    }

    header button {
      background: #ef4444;
      border: none;
      color: white;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
    }

    main {
      padding: 15px;
      max-width: 900px;
      margin: 0 auto 40px auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.08);
    }

    h2, h3 {
      margin: 0 0 10px 0;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
    }

    button:hover {
      background: var(--primary-dark);
    }

    .btn-small {
      width: auto;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      margin: 0 2px;
    }

    .muted {
      font-size: 12px;
      color: var(--muted);
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .row > div {
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    th {
      background: #e5e7eb;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 11px;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #loginBox {
      width: 100%;
      max-width: 380px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      text-align: center;
    }

    #loginBox h2 {
      margin-bottom: 5px;
    }

    .lang-buttons {
      margin: 8px 0 4px;
    }

    .lang-buttons button {
      width: auto;
      padding: 5px 10px;
      margin: 0 3px;
      font-size: 12px;
      border-radius: 999px;
    }

    /* Ø£ÙˆÙØ±Ù„ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
    #gpsOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.96);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }

    #gpsBox {
      max-width: 420px;
      width: 100%;
      background: #020617;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      text-align: center;
    }

    #gpsBox h2 {
      margin-bottom: 10px;
    }

    #gpsBox p {
      font-size: 14px;
      color: #9ca3af;
      margin: 5px 0;
    }

    #gpsBox button {
      margin-top: 10px;
      border-radius: 999px;
    }

    #gpsStatus {
      font-size: 12px;
      margin-top: 6px;
      min-height: 16px;
    }

    /* AI box */
    .ai-box {
      background: #eff6ff;
      border-radius: 14px;
      padding: 10px;
      margin-top: 10px;
      text-align: right;
    }

    .ai-title {
      font-size: 13px;
      color: #1d4ed8;
      font-weight: 600;
      margin-bottom: 4px;
    }

    #aiText {
      font-size: 13px;
      white-space: pre-line;
    }

    /* ØªØ¨ÙˆÙŠØ¨Ø§Øª (Ù…ÙŠØ²Ø§Ù†ÙŠØ© / Ø¥Ø¯Ø§Ø±Ø©) Ù„Ù„Ø£Ø¯Ù…Ù† */
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 3px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 13px;
      padding: 6px;
      color: #4b5563;
    }

    .tab-btn.active {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 600px) {
      main {
        padding: 10px;
      }

      header .title {
        font-size: 16px;
      }

      header .user-info {
        font-size: 11px;
      }

      .row {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <!-- Ø´Ø§Ø´Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡) -->
  <div id="gpsOverlay">
    <div id="gpsBox">
      <h2>ğŸ“ ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
      <p>Ù„Ø£Ù…Ø§Ù† Ø£Ø¹Ù„Ù‰ ÙˆØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ù‚ØŒ ÙŠØ­ØªØ§Ø¬ <b>ØªØ­Ù„ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠÙ‡</b> Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.</p>
      <p class="muted">Ù„Ù† ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹Ùƒ Ù…Ø¹ Ø£ÙŠ Ø·Ø±Ù Ø¢Ø®Ø±ØŒ ÙÙ‚Ø· ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø°ÙŠ ÙŠØµÙ„Ùƒ Ø£Ù†Øª.</p>
      <button onclick="requestLocation()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†</button>
      <div id="gpsStatus"></div>
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginScreen" class="hidden">
    <div id="loginBox">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <p class="muted">Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø´Ø®ØµÙŠ. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>

      <div class="lang-buttons">
        <button class="btn-small" onclick="setLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
        <button class="btn-small" onclick="setLang('ku')">Ú©ÙˆØ±Ø¯ÛŒ</button>
        <button class="btn-small" onclick="setLang('en')">English</button>
      </div>

      <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
      <p class="muted" id="loginHint">Admin: admin / 123456</p>
    </div>
  </div>

  <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <header class="hidden" id="appHeader">
    <div class="title">ØªØ­Ù„ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠÙ‡</div>
    <div class="user-info">
      <div id="headerUser">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: â€”</div>
      <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main class="hidden" id="appMain">
    <div class="card">
      <div class="tabs" id="adminTabs" style="display:none;">
        <button class="tab-btn active" id="tabBudget" onclick="switchTab('budget')">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>
        <button class="tab-btn" id="tabAdmin" onclick="switchTab('admin')">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
      </div>

      <div id="currentRole" class="muted"></div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <section id="budgetSection">
      <div class="card">
        <h3 id="salaryLabel">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
        <input type="number" id="salaryInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø§ØªØ¨Ùƒ">
        <button onclick="saveSalary()" id="saveSalaryBtn">Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨</button>

        <div class="row" style="margin-top:10px;">
          <div>
            <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
            <div><span class="badge" id="totalSpend">0</span></div>
          </div>
          <div>
            <div class="muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨</div>
            <div><span class="badge" id="remainSalary">0</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 id="addExpenseLabel">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
        <input type="date" id="expDate">
        <select id="expType">
          <option value="Food">Ø£ÙƒÙ„</option>
          <option value="Rent">Ø¥ÙŠØ¬Ø§Ø±</option>
          <option value="Internet">Ø¥Ù†ØªØ±Ù†Øª</option>
          <option value="Transport">Ù†Ù‚Ù„</option>
          <option value="Shopping">ØªØ³ÙˆÙ‚</option>
          <option value="Other">ØºÙŠØ± Ø°Ù„Ùƒ</option>
        </select>
        <input placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©" id="note">
        <input type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" id="amount">
        <button onclick="addExpense()" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>

        <div class="ai-box">
          <div class="ai-title">ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ</div>
          <div id="aiText">Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ ÙˆØ£Ø¶Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙØŒ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØµØ±ÙÙƒ Ø¨Ø«Ù„Ø§Ø« Ù„ØºØ§Øª.</div>
        </div>
      </div>

      <div class="card">
        <h3 id="listLabel">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
        <div class="muted" id="gpsInfo">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØ¹Ù„: â€”</div>
        <table>
          <thead>
            <tr>
              <th id="tDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th id="tType">Ø§Ù„Ù†ÙˆØ¹</th>
              <th id="tNote">Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              <th id="tAmount">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            </tr>
          </thead>
          <tbody id="expTable"></tbody>
        </table>
        <button onclick="exportExcel()" style="margin-top:10px;">ğŸ“Š ØªØ­Ù…ÙŠÙ„ CSV (Excel)</button>
      </div>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) -->
    <section id="adminSection" class="hidden">
      <div class="card">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <p class="muted">Ø£Ù†Øª Ø§Ù„Ø£Ø¯Ù…Ù†. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¬Ø¯Ø¯ ÙˆÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ù…ØµØ§Ø±ÙŠÙÙ‡ Ø§Ù„Ø®Ø§ØµØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ù‡.</p>
        <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
        <input type="password" id="newUserPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <button onclick="addUser()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
      </div>

      <div class="card">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
        <table>
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¯ÙˆØ±</th>
              <th>Ø¹Ù…Ù„ÙŠØ§Øª</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </div>
    </section>

  </main>

<script>
  // =========================
  //  Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© / Ù„ØºØ©
  // =========================
  let currentLang = "ar";
  let currentUser = null; // { username, role }
  let users = [];         // { username, password, role }
  let salary = 0;
  let expenses = [];      // per-user
  let gpsLat = null;
  let gpsLng = null;

  const ACCESS_KEY = "454def9e-a3b5-4498-94de-14db3899650c";

  const lang = {
    ar: {
      loginHint: "Admin: admin / 123456",
      salaryLabel: "Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ",
      saveSalaryBtn: "Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨",
      addExpenseLabel: "Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ",
      listLabel: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ",
      tDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
      tType: "Ø§Ù„Ù†ÙˆØ¹",
      tNote: "Ù…Ù„Ø§Ø­Ø¸Ø©",
      tAmount: "Ø§Ù„Ù…Ø¨Ù„Øº",
      aiIntro: "Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ ÙˆØ£Ø¶Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙØŒ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† ØµØ±ÙÙƒ Ø¨Ø«Ù„Ø§Ø« Ù„ØºØ§Øª.",
      roleAdmin: "Ø§Ù„Ø¯ÙˆØ±: Ø£Ø¯Ù…Ù† (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)",
      roleUser: "Ø§Ù„Ø¯ÙˆØ±: Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ"
    },
    ku: {
      loginHint: "Admin: admin / 123456",
      salaryLabel: "Ù…ÙˆÙˆÚ†Û•ÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•",
      saveSalaryBtn: "Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†ÛŒ Ù…ÙˆÙˆÚ†Û•",
      addExpenseLabel: "Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø®Û•Ø±Ø¬ÛŒ",
      listLabel: "Ù„ÛŒØ³ØªÛŒ Ø®Û•Ø±Ø¬ÛŒÛ•Ú©Ø§Ù†",
      tDate: "Ø±ÛÚ©Û•ÙˆØª",
      tType: "Ø¬Û†Ø±",
      tNote: "ØªÛØ¨ÛŒÙ†ÛŒ",
      tAmount: "Ø¨Ú•",
      aiIntro: "Ù…ÙˆÙˆÚ†Û•Ú©Û•Øª Ø¯Ø§Ø®Ù„ Ø¨Ú©Û• Ùˆ Ø®Û•Ø±Ø¬ÛŒ Ø²ÛŒØ§Ø¯ Ø¨Ú©Û•ØŒ Ù…Ù† Ú•Ø§Ù¾Û†Ø±Øª Ùˆ Ú•Ø§ÙˆÛŒØ³ØªÛŒ Ø®Û•Ø±Ø¬ÛŒ Ø¨Û†Øª Ø¯Û•Ù….",
      roleAdmin: "Ú•Û†Úµ: Ø¨Û•Ú•ÛÙˆØ¨Û•Ø± (Ø¦Ø§Ø¯Ù…ÛŒÙ†)",
      roleUser: "Ú•Û†Úµ: Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±ÛŒ Ø¦Ø§Ø³Ø§ÛŒÛŒ"
    },
    en: {
      loginHint: "Admin: admin / 123456",
      salaryLabel: "Monthly Salary",
      saveSalaryBtn: "Save Salary",
      addExpenseLabel: "Add Expense",
      listLabel: "Expenses List",
      tDate: "Date",
      tType: "Type",
      tNote: "Note",
      tAmount: "Amount",
      aiIntro: "Enter your salary and some expenses, I'll give you insights and saving tips.",
      roleAdmin: "Role: Admin",
      roleUser: "Role: User"
    }
  };

  function setLang(l) {
    currentLang = l;
    document.getElementById("loginHint").innerText = lang[l].loginHint;
    document.getElementById("salaryLabel").innerText = lang[l].salaryLabel;
    document.getElementById("saveSalaryBtn").innerText = lang[l].saveSalaryBtn;
    document.getElementById("addExpenseLabel").innerText = lang[l].addExpenseLabel;
    document.getElementById("listLabel").innerText = lang[l].listLabel;
    document.getElementById("tDate").innerText = lang[l].tDate;
    document.getElementById("tType").innerText = lang[l].tType;
    document.getElementById("tNote").innerText = lang[l].tNote;
    document.getElementById("tAmount").innerText = lang[l].tAmount;
    document.getElementById("aiText").innerText = lang[l].aiIntro;
    updateRoleText();
    aiAnalyze();
  }

  // =========================
  //  GPS Overlay
  // =========================
  function requestLocation() {
    const status = document.getElementById("gpsStatus");
    status.style.color = "#e5e7eb";
    status.innerText = "â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­...";

    if (!navigator.geolocation) {
      status.innerText = "Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        gpsLat = pos.coords.latitude.toFixed(6);
        gpsLng = pos.coords.longitude.toFixed(6);

        // Ù†Ø®Ø²Ù†Ù‡Ø§ Ø­ØªÙ‰ ØªØ¨Ù‚Ù‰ (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆÙ„ÙŠØ³ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆØ²Ø±)
        localStorage.setItem("bm_gps_lat", gpsLat);
        localStorage.setItem("bm_gps_lng", gpsLng);

        document.getElementById("gpsOverlay").classList.add("hidden");
        document.getElementById("loginScreen").classList.remove("hidden");
      },
      (err) => {
        status.style.color = "#fca5a5";
        status.innerText = "Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.";
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  // =========================
  //  Users & Admin
  // =========================
  function loadUsers() {
    const data = localStorage.getItem("bm_users");
    if (data) {
      try {
        users = JSON.parse(data);
      } catch {
        users = [];
      }
    }
    // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ø£Ø¯Ù…Ù†ØŒ Ù†Ø¶ÙŠÙÙ‡ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    if (!users.some(u => u.username === "admin")) {
      users.push({ username: "admin", password: "123456", role: "admin" });
      saveUsers();
    }
  }

  function saveUsers() {
    localStorage.setItem("bm_users", JSON.stringify(users));
  }

  function login() {
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value.trim();
    if (!u || !p) {
      alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
      return;
    }

    const user = users.find(x => x.username === u && x.password === p);
    if (!user) {
      alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      return;
    }

    currentUser = { username: user.username, role: user.role };
    localStorage.setItem("bm_currentUser", JSON.stringify(currentUser));

    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("appHeader").classList.remove("hidden");
    document.getElementById("appMain").classList.remove("hidden");

    document.getElementById("headerUser").innerText = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + currentUser.username;

    if (currentUser.role === "admin") {
      document.getElementById("adminTabs").style.display = "flex";
    } else {
      document.getElementById("adminTabs").style.display = "none";
    }

    loadUserData();
    renderUsersTable();
    updateRoleText();
    setLang(currentLang); // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†ØµÙˆØµ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem("bm_currentUser");
    document.getElementById("appHeader").classList.add("hidden");
    document.getElementById("appMain").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
  }

  function updateRoleText() {
    if (!currentUser) return;
    const el = document.getElementById("currentRole");
    if (currentLang === "ar") {
      el.innerText = currentUser.role === "admin" ? lang.ar.roleAdmin : lang.ar.roleUser;
    } else if (currentLang === "ku") {
      el.innerText = currentUser.role === "admin" ? lang.ku.roleAdmin : lang.ku.roleUser;
    } else {
      el.innerText = currentUser.role === "admin" ? lang.en.roleAdmin : lang.en.roleUser;
    }
  }

  function switchTab(tab) {
    if (tab === "budget") {
      document.getElementById("budgetSection").classList.remove("hidden");
      document.getElementById("adminSection").classList.add("hidden");
      document.getElementById("tabBudget").classList.add("active");
      document.getElementById("tabAdmin").classList.remove("active");
    } else {
      document.getElementById("budgetSection").classList.add("hidden");
      document.getElementById("adminSection").classList.remove("hidden");
      document.getElementById("tabBudget").classList.remove("active");
      document.getElementById("tabAdmin").classList.add("active");
      renderUsersTable();
    }
  }

  function addUser() {
    const name = document.getElementById("newUserName").value.trim();
    const pass = document.getElementById("newUserPass").value.trim();
    if (!name || !pass) {
      alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
      return;
    }
    if (users.some(u => u.username === name)) {
      alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
      return;
    }
    users.push({ username: name, password: pass, role: "user" });
    saveUsers();
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    renderUsersTable();
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
  }

  function deleteUser(username) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… " + username + "ØŸ")) return;
    users = users.filter(u => u.username !== username);
    saveUsers();
    // Ù…Ù…ÙƒÙ† Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    localStorage.removeItem("bm_salary_" + username);
    localStorage.removeItem("bm_expenses_" + username);
    renderUsersTable();
  }

  function renderUsersTable() {
    if (!currentUser || currentUser.role !== "admin") return;
    const tbody = document.getElementById("usersTable");
    tbody.innerHTML = "";
    users.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>${u.role}</td>
        <td>
          ${u.username === "admin" ? "" : `<button class="btn-small" onclick="deleteUser('${u.username}')">Ø­Ø°Ù</button>`}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // =========================
  //  Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø±Ø§ØªØ¨ + Ù…ØµØ§Ø±ÙŠÙ)
  // =========================
  function loadUserData() {
    if (!currentUser) return;
    const s = localStorage.getItem("bm_salary_" + currentUser.username);
    salary = s ? Number(s) : 0;
    document.getElementById("salaryInput").value = salary || "";

    const exp = localStorage.getItem("bm_expenses_" + currentUser.username);
    if (exp) {
      try {
        expenses = JSON.parse(exp);
      } catch {
        expenses = [];
      }
    } else {
      expenses = [];
    }

    // GPS info
    gpsLat = localStorage.getItem("bm_gps_lat") || gpsLat;
    gpsLng = localStorage.getItem("bm_gps_lng") || gpsLng;
    updateGpsInfo();

    renderExpenses();
    updateTotals();
    aiAnalyze();
  }

  function saveUserData() {
    if (!currentUser) return;
    localStorage.setItem("bm_salary_" + currentUser.username, salary.toString());
    localStorage.setItem("bm_expenses_" + currentUser.username, JSON.stringify(expenses));
  }

  function saveSalary() {
    if (!gpsLat || !gpsLng) {
      alert("Ø±Ø¬Ø§Ø¡Ù‹ ÙØ¹Ù‘Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨.");
      return;
    }
    const value = Number(document.getElementById("salaryInput").value);
    if (!value) {
      alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
      return;
    }
    salary = value;
    saveUserData();
    updateTotals();
    aiAnalyze();
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§ØªØ¨.");
  }

  function addExpense() {
    if (!gpsLat || !gpsLng) {
      alert("Ø±Ø¬Ø§Ø¡Ù‹ ÙØ¹Ù‘Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ.");
      return;
    }

    const date = document.getElementById("expDate").value;
    const type = document.getElementById("expType").value;
    const note = document.getElementById("note").value || "-";
    const amountStr = document.getElementById("amount").value;
    const amount = Number(amountStr);

    if (!date || !amount) {
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº.");
      return;
    }

    const expObj = { date, type, note, amount };
    expenses.push(expObj);
    saveUserData();
    renderExpenses();
    updateTotals();
    aiAnalyze();

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø¹ Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†
    const formEl = document.createElement("form");
    const locText = gpsLat && gpsLng ? `Lat: ${gpsLat}, Lng: ${gpsLng}` : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";

    formEl.innerHTML = `
      <input type="hidden" name="access_key" value="${ACCESS_KEY}">
      <input type="hidden" name="user" value="${currentUser.username}">
      <input type="hidden" name="date" value="${date}">
      <input type="hidden" name="type" value="${type}">
      <input type="hidden" name="note" value="${note}">
      <input type="hidden" name="amount" value="${amount}">
      <input type="hidden" name="location" value="${locText}">
    `;

    fetch("https://api.web3forms.com/submit", {
      method: "POST",
      body: new FormData(formEl)
    })
      .then(r => r.json())
      .then(r => {
        console.log("Web3Forms:", r);
      })
      .catch(err => console.log("Web3Forms error", err));

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById("note").value = "";
    document.getElementById("amount").value = "";
  }

  function renderExpenses() {
    const tbody = document.getElementById("expTable");
    tbody.innerHTML = "";
    expenses.forEach(e => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.date}</td>
        <td>${e.type}</td>
        <td>${e.note}</td>
        <td>${e.amount}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateTotals() {
    const total = expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const remain = (salary || 0) - total;
    document.getElementById("totalSpend").innerText = total;
    document.getElementById("remainSalary").innerText = remain;
  }

  function updateGpsInfo() {
    const el = document.getElementById("gpsInfo");
    if (gpsLat && gpsLng) {
      el.innerText = `Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØ¹Ù„: (${gpsLat}, ${gpsLng})`;
    } else {
      el.innerText = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ÙØ¹Ù„ Ø¨Ø¹Ø¯.";
    }
  }

  function exportExcel() {
    if (!expenses.length) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„ØªØµØ¯ÙŠØ±.");
      return;
    }
    let csv = "Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù†ÙˆØ¹,Ù…Ù„Ø§Ø­Ø¸Ø©,Ø§Ù„Ù…Ø¨Ù„Øº\n";
    expenses.forEach(e => {
      csv += `${e.date},${e.type},${e.note},${e.amount}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "expenses.csv";
    a.click();
  }

  // =========================
  //  Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  // =========================
  function aiAnalyze() {
    const el = document.getElementById("aiText");
    if (!el) return;

    if (!salary) {
      if (currentLang === "ar") {
        el.innerText = "Ø£Ø¯Ø®Ù„ Ø±Ø§ØªØ¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ø­ØªÙ‰ Ø£Ø³ØªØ·ÙŠØ¹ ØªØ­Ù„ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„ØµØ±Ù.";
      } else if (currentLang === "ku") {
        el.innerText = "Ø³Û•Ø±Û•ØªØ§ Ù…ÙˆÙˆÚ†Û•Ú©Û• Ø¯Ø§Ø®Ù„ Ø¨Ú©Û• Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ø¨ØªÙˆØ§Ù†Ù… Ø®Û•Ø±Ø¬ÛŒÛ•Ú©Ø§Ù†Øª Ø¨ÚµØ§Ùˆ Ø¨Ú©Û•Ù…Û•ÙˆÛ•.";
      } else {
        el.innerText = "Enter your salary first so I can analyze your spending.";
      }
      return;
    }

    if (!expenses.length) {
      if (currentLang === "ar") {
        el.innerText = "Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…ØµØ±ÙˆÙ ÙˆØ³Ø£Ø®Ø¨Ø±Ùƒ Ø¥Ø°Ø§ ØµØ±ÙÙƒ Ø·Ø¨ÙŠØ¹ÙŠ Ø£Ùˆ Ø¹Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø±Ø§ØªØ¨Ùƒ.";
      } else if (currentLang === "ku") {
        el.innerText = "ÛŒÛ•Ú©Û•Ù… Ø®Û•Ø±Ø¬ÛŒ Ø²ÛŒØ§Ø¯ Ø¨Ú©Û•ØŒ Ø¯ÙˆØ§ØªØ± Ø¯Û•ÚµÛÙ… Ø¦Ø§ÛŒØ§ Ø¨Û•Ø±Ø§ÙˆØ±Ø¯ Ø¨Û• Ù…ÙˆÙˆÚ†Û•Ú©Û•Øª Ø²Û†Ø±Û• ÛŒØ§Ù† Ù†Ø§.";
      } else {
        el.innerText = "Add your first expense and I'll tell you if your spending is normal or high.";
      }
      return;
    }

    const total = expenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
    const percent = (total / salary) * 100;
    let msg = "";

    // Ø§Ù„Ø£Ø³Ø§Ø³ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    if (currentLang === "ar") {
      msg += `ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµØ±Ù: ${total} Ù…Ù† Ø±Ø§ØªØ¨ ${salary} (${percent.toFixed(1)}%).\n`;
      if (percent < 30) msg += "âœ… ØµØ±ÙÙƒ Ù…Ù…ØªØ§Ø² ÙˆÙ…Ø³ÙŠØ·Ø± Ø¹Ù„ÙŠÙ‡.\n";
      else if (percent < 70) msg += "âš ï¸ ØµØ±ÙÙƒ Ù…ØªÙˆØ³Ø·ØŒ Ø§Ù†ØªØ¨Ù‡ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ù‡Ø±.\n";
      else msg += "ğŸš¨ ØµØ±ÙÙƒ Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø­ØªÙ…Ø§Ù„ ØªØ®Ù„Øµ ÙÙ„ÙˆØ³Ùƒ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±.\n";

      const internet = expenses.filter(e => e.type === "Internet" || e.type === "Ø¥Ù†ØªØ±Ù†Øª")
        .reduce((s, e) => s + Number(e.amount || 0), 0);
      if (internet > salary * 0.1) {
        msg += "ğŸ’¡ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ø¹Ù„Ù‰ Ù…Ù† 10% Ù…Ù† Ø±Ø§ØªØ¨ÙƒØŒ ÙÙƒØ± Ø¨ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø·Ø©.\n";
      }

      const foodCount = expenses.filter(e => e.type === "Food" || e.type === "Ø£ÙƒÙ„").length;
      if (foodCount >= 5) msg += "ğŸ” Ø¹Ù†Ø¯Ùƒ ÙˆØ¬Ø¨Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨ÙŠØªØŒ Ø¬Ø±Ù‘Ø¨ ØªØ·Ø¨Ø® Ø¨Ø§Ù„Ø¨ÙŠØª Ø­ØªÙ‰ ØªÙˆÙÙ‘Ø± Ø£ÙƒØ«Ø±.\n";

    } else if (currentLang === "ku") {
      msg += `ğŸ“Š Ú©Û†ÛŒ Ø®Û•Ø±Ø¬ÛŒ: ${total} Ù„Û• Ù…ÙˆÙˆÚ†Û•ÛŒ ${salary} (${percent.toFixed(1)}%).\n`;
      if (percent < 30) msg += "âœ… Ø®Û•Ø±Ø¬ÛŒÚ©Û•Øª Ø²Û†Ø± Ø¨Ø§Ø´Û• Ùˆ Ø¨Û•Ú•ÛÙˆØ¨Û•Ø±ÛŒ Ø¨Ø§Ø´ Ø¯Û•Ú©Û•ÛŒØª.\n";
      else if (percent < 70) msg += "âš ï¸ Ø®Û•Ø±Ø¬ÛŒÛ•Ú©Ø§Ù†Øª Ù†Ø§ÙˆÛ•Ù†Ø¯ÛŒÙ†ØŒ Ù‡Û•ÙˆÚµ Ø¨Ø¯Û• Ù…Ø§ÙˆÛ•ÛŒ Ù…Ø§Ù†Ú¯ Ø¨Ø¨ÛŒÙ†ÛŒØª.\n";
      else msg += "ğŸš¨ Ø®Û•Ø±Ø¬ÛŒÚ©Û•Øª Ø²Û†Ø± Ú†ÛÚ˜Ø§ÙˆÛ•ØŒ Ù„Û•ÙˆØ§Ù†Û•ÛŒÛ• Ù…ÙˆÙˆÚ†Û•Ú©Û•Øª Ù¾ÛØ´ Ù…Ø§Ù†Ú¯ Ú©Û†ØªØ§ÛŒÛŒ ÛŒÛ• Ø¨ÛØª.\n";

      const internet = expenses.filter(e => e.type === "Internet" || e.type === "Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª")
        .reduce((s, e) => s + Number(e.amount || 0), 0);
      if (internet > salary * 0.1) {
        msg += "ğŸ’¡ Ø®Û•Ø±Ø¬ÛŒ Ø³Û•Ø± Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª Ø¨Û•Ø±Ø²Û•ØŒ Ø¨Ø§Ø´ØªØ±Û• Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒØ¯Ø§Ù†Û•Ú©Ø§Ù† Ùˆ Ù¾Ø§Ú©Û•ØªÛ•Ú©Ø§Ù† Ø¨Ù¾Ø´Ú©Ù†ÛŒØªÛ•ÙˆÛ•.\n";
      }

    } else {
      msg += `ğŸ“Š Total spending: ${total} out of a salary of ${salary} (${percent.toFixed(1)}%).\n`;
      if (percent < 30) msg += "âœ… Your spending is very healthy so far.\n";
      else if (percent < 70) msg += "âš ï¸ Your spending is moderate, keep an eye on the rest of the month.\n";
      else msg += "ğŸš¨ Your spending is very high, you may run out of money before month-end.\n";

      const internet = expenses.filter(e => e.type === "Internet")
        .reduce((s, e) => s + Number(e.amount || 0), 0);
      if (internet > salary * 0.1) {
        msg += "ğŸ’¡ Internet cost is high, consider a cheaper plan.\n";
      }
    }

    el.innerText = msg;
  }

  // =========================
  //  Dark mode toggle
  // =========================
  function toggleDark() {
    document.body.classList.toggle("dark-mode");
  }

  // =========================
  //  On load
  // =========================
  window.addEventListener("load", () => {
    loadUsers();
    setLang("ar"); // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ø±Ø¨ÙŠ
    // GPS overlay ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
    // Ù…Ø§ Ù†Ø¹Ø±Ø¶ login ÙˆÙ„Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ GPS
  });
</script>

</body>
</html>
